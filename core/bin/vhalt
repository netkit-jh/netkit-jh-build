#!/usr/bin/env bash

#     Copyright 2002-2009 Maurizio Patrignani, Maurizio Pizzonia, Fabio Ricci,
#     Massimo Rimondini - Computer Networks Research Group, Roma Tre University.
#
#     This file is part of Netkit.
# 
#     Netkit is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
# 
#     Netkit is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
# 
#     You should have received a copy of the GNU General Public License
#     along with Netkit.  If not, see <http://www.gnu.org/licenses/>.

# This is the Netkit vhalt script, which is used to gracefully shut down a
# virtual machine.

SCRIPTNAME=$(basename "$0")

if [ -z "$NETKIT_HOME" ]; then
   echo 1>&2 "$SCRIPTNAME: The NETKIT_HOME environment variable is not set"
   exit 1
fi

# shellcheck source=./script_utils
. "$NETKIT_HOME/bin/script_utils"

# Write to the vcommands log
log_write "$0 $*"


###############################################################################
# Write vhalt's usage line to standard output.
# Usage:
#   usage_line
# Globals:
#   r- SCRIPTNAME
# Arguments:
#   None
# Returns:
#   None
# Example:
#   None
###############################################################################
usage_line() {
   echo "Usage: $SCRIPTNAME [OPTION]... MACHINE..."
}


###############################################################################
# Write vhalt's usage as a full dialog or a "try --help".
# Usage:
#   usage STATUS
# Globals:
#   r- SCRIPTNAME
# Arguments:
#   $1 - status code to exit with. When zero, usage will write to standard
#        output and describe all options (for --help). Else, it will write to
#        standard error and be a brief usage and try-help message.
# Returns:
#   None - exits with a status code of STATUS
# Example:
#   None
###############################################################################
usage() {
   status=$1

   if [ "$status" -ne 0 ]; then
      usage_line 1>&2
      try_help
      exit "$status"
   fi

   cat << END_OF_HELP
$(usage_line)
Gracefully shutdown running MACHINE(s).

  -q, --quick
      --quiet         do not wait for virtual machines to shut down. Just issue
                        the halt command and exit. Using this option also
                        suppresses any output except errors and warnings
  -r, --remove-fs     delete virtual machine (COW) filesystem after halting
                        machine. Using this option has no effect on machines
                        started with the --no-cow option. Log files are not
                        removed
  -u, --user=USERNAME  halt virtual machine(s) owned by user USERNAME. By using
                        the special user name '-' any virtual machine can be
                        halted, regardless of its owner (administrative
                        privileges are required)

Miscellaneous:
$(help_option)
$(version_option)

END_OF_HELP

   exit "$status"
}


# Get command line options
LONG_OPTS="help,quick,quiet,remove-fs,user:,version"
SHORT_OPTS="qru:"

if ! GETOPT_OPTS=$(getopt --name "$SCRIPTNAME" --options "$SHORT_OPTS" --longoptions "$LONG_OPTS" -- "$@"); then
   # getopt will output the errorneous command-line argument
   usage 1
fi

# USERID is set in script_utils
USER=$USERID

# (Safely) set positional parameters to those reordered by getopt
eval set -- "$GETOPT_OPTS"

while true; do
   case $1 in
      --help)
         usage 0
         ;;
      # TODO: Remove --quiet. Have --verbose and --quick (independent).
      -q|--quick|--quiet)
         BE_QUIET=1
         ;;
      -r|--remove-fs)
         REMOVE_FS=1
         ;;
      -u|--user)
         USER=$2
         [ "$USER" = "-" ] && unset USER
         shift
         ;;
      --version)
         show_version
         exit 0
         ;;
      --)
         shift
         break
         ;;
      *)
         echo 1>&2 "$SCRIPTNAME: Unknown error parsing command line arguments"
         usage 1
         ;;
   esac

   shift
done

# Non-option arguments are machine names
vm_hostnames=( "$@" )

for host in "${vm_hostnames[@]}"; do
   if string_contains " " "$host"; then
      echo 1>&2 "$SCRIPTNAME: Hostname cannot contain whitespace"
      exit 1
   fi
done


# Check whether virtual machine name is missing
if [ "${#vm_hostnames[@]}" -eq 0 ]; then
   echo 1>&2 "$SCRIPTNAME: Missing virtual machine name"
   exit 1
fi


# Virtual machine filesystem cannot be removed in quiet mode because the
# machine may write files during shutdown
if [ -n "$REMOVE_FS" ] && [ -n "$BE_QUIET" ]; then
   echo 1>&2 "$SCRIPTNAME: Filesystem cannot be removed in quiet mode"
   exit 1
fi


for vm in "${vm_hostnames[@]}"; do
   if ! get_vm_info_by_name "$USER" "$vm"; then
      echo -n 1>&2 "$SCRIPTNAME: no virtual machine named '$vm' exists"
      [ -n "$USER" ] && echo " for user $USER." || echo "."
      exit 1
   fi

   [ -z "$BE_QUIET" ] && echo -e -n "Halting '$vm' (PID ${vm_info[pid]}) owned by \
   $USER [                    ]\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b"

   # Old method uses CTRL-ALT-DEL. This yields the error
   #   harddog_open - run_helper failed, errno = -2
   # and subsequently reboots (as opposed to powering off.)
   #"$NETKIT_HOME/bin/uml_mconsole" "$vm" cad > /dev/null

   # TODO: Try to use the old method - it uses /sbin/shutdown and is safer and
   # quicker.
   # New method uses the Magic SysRq key in the REISUO combination (R is not
   # included because there is no X server).
   # This method is not perfect; the timings required are rough estimates. The
   # system will return "OK" to uml_mconsole upon a valid command being sent,
   # NOT when the command has completed. e and i cannot be expected to finish
   # in the time given by the delay. s, u, and o are almost instant.

   # e: send a SIGTERM to all processes, except for init
   "$NETKIT_HOME/bin/uml_mconsole" "$vm" sysrq e > /dev/null
   sleep 2

   # i: send a SIGKILL to all processes, except for init
   "$NETKIT_HOME/bin/uml_mconsole" "$vm" sysrq i > /dev/null
   sleep 2

   # s: attempt to sync all mounted filesystems
   "$NETKIT_HOME/bin/uml_mconsole" "$vm" sysrq s > /dev/null
   sleep 0.2

   # u: attempt to remount all mounted filesystems read-only
   "$NETKIT_HOME/bin/uml_mconsole" "$vm" sysrq u > /dev/null
   sleep 0.2

   # o: shut the system off (if configured and supported)
   "$NETKIT_HOME/bin/uml_mconsole" "$vm" sysrq o > /dev/null

   if [ -z "$BE_QUIET" ]; then
      ATTEMPTS=1
      while get_machine_state "$USER" "$vm"; do
         sleep 1
         echo -n "."

         [ $ATTEMPTS -eq 20 ] && break
         ATTEMPTS=$((ATTEMPTS + 1))
      done

      echo

      # If machine is still up
      if get_machine_state "$USER" "$vm"; then
         echo 1>&2 "$SCRIPTNAME: could not shut down '$vm'."
      else
         if [ -n "$REMOVE_FS" ] && [ -n "${vm_info[disk]}" ]; then
            remove_fs "${vm_info[disk]}"
         fi
      fi
   fi
done
